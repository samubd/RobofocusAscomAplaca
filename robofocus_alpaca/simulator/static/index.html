<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robofocus Simulator Control Panel</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section h2 {
            color: #555;
            font-size: 1.2em;
            margin-bottom: 15px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
        }

        .status-display {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-item {
            flex: 1;
            min-width: 150px;
        }

        .status-label {
            font-size: 0.9em;
            color: #777;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 1em;
            font-weight: bold;
        }

        .status-idle {
            background-color: #4CAF50;
            color: white;
        }

        .status-moving {
            background-color: #FF9800;
            color: white;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        button {
            padding: 12px 20px;
            font-size: 1em;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            transition: all 0.3s;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-step {
            background-color: #2196F3;
            color: white;
            flex: 1;
            min-width: 100px;
        }

        .btn-step:hover:not(:disabled) {
            background-color: #1976D2;
        }

        .btn-halt {
            background-color: #f44336;
            color: white;
            font-size: 1.2em;
            padding: 15px 30px;
            width: 100%;
        }

        .btn-halt:hover {
            background-color: #d32f2f;
        }

        .btn-goto {
            background-color: #673AB7;
            color: white;
        }

        .btn-goto:hover:not(:disabled) {
            background-color: #512DA8;
        }

        input[type="number"] {
            padding: 10px;
            font-size: 1em;
            border: 2px solid #ddd;
            border-radius: 5px;
            width: 100%;
            margin-bottom: 10px;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #2196F3;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-group input {
            flex: 1;
            margin-bottom: 0;
        }

        .error-box {
            background-color: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #c62828;
            margin-top: 15px;
            display: none;
        }

        .error-box.show {
            display: block;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .config-label {
            font-weight: 500;
            color: #666;
        }

        .config-value {
            color: #333;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .button-group {
                flex-direction: column;
            }

            .btn-step {
                width: 100%;
            }

            .config-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <h1>üî≠ Robofocus Simulator Control Panel</h1>

    <!-- Status Display -->
    <div class="section">
        <h2>Status</h2>
        <div class="status-display">
            <div class="status-item">
                <div class="status-label">Current Position</div>
                <div class="status-value" id="position">0</div>
            </div>
            <div class="status-item">
                <div class="status-label">Status</div>
                <div>
                    <span class="status-badge status-idle" id="status">IDLE</span>
                </div>
            </div>
            <div class="status-item">
                <div class="status-label">Temperature</div>
                <div class="status-value" id="temperature">--</div>
            </div>
        </div>
    </div>

    <!-- Quick Step Controls -->
    <div class="section">
        <h2>Quick Step Controls</h2>
        <div class="button-group">
            <button class="btn-step" id="btn-minus10" onclick="moveSteps(10, 'in')">-10 Steps</button>
            <button class="btn-step" id="btn-minus1" onclick="moveSteps(1, 'in')">-1 Step</button>
            <button class="btn-step" id="btn-plus1" onclick="moveSteps(1, 'out')">+1 Step</button>
            <button class="btn-step" id="btn-plus10" onclick="moveSteps(10, 'out')">+10 Steps</button>
        </div>
    </div>

    <!-- Custom Step Control -->
    <div class="section">
        <h2>Custom Step Movement</h2>
        <input type="number" id="custom-steps" placeholder="Enter number of steps" min="1" value="100">
        <div class="button-group">
            <button class="btn-step" onclick="moveCustomSteps('in')">-N Steps</button>
            <button class="btn-step" onclick="moveCustomSteps('out')">+N Steps</button>
        </div>
    </div>

    <!-- Absolute Position -->
    <div class="section">
        <h2>Absolute Position</h2>
        <div class="input-group">
            <input type="number" id="goto-position" placeholder="Enter target position" min="0" max="60000" value="0">
            <button class="btn-goto" onclick="goToPosition()">GoTo</button>
        </div>
    </div>

    <!-- Halt Button -->
    <div class="section">
        <h2>Emergency Stop</h2>
        <button class="btn-halt" onclick="halt()">‚ö†Ô∏è HALT</button>
    </div>

    <!-- Configuration -->
    <div class="section">
        <h2>Configuration</h2>
        <div class="config-grid">
            <div class="config-item">
                <span class="config-label">Max Position:</span>
                <span class="config-value" id="max-step">60000</span>
            </div>
            <div class="config-item">
                <span class="config-label">Firmware Version:</span>
                <span class="config-value" id="firmware-version">2.1.0</span>
            </div>
        </div>
    </div>

    <!-- Error Messages -->
    <div id="error-box" class="error-box"></div>

    <script>
        let pollingInterval = null;
        let state = {
            position: 0,
            target: 0,
            isMoving: false,
            temperature: 0,
            maxStep: 60000
        };

        // Update status from server
        async function updateStatus() {
            try {
                const response = await fetch('/simulator/status');
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }

                const data = await response.json();
                state = {
                    position: data.position,
                    target: data.target_position,
                    isMoving: data.is_moving,
                    temperature: data.temperature,
                    maxStep: data.max_step
                };

                // Update DOM
                document.getElementById('position').textContent = data.position;
                document.getElementById('temperature').textContent = data.temperature.toFixed(2) + '¬∞C';
                document.getElementById('max-step').textContent = data.max_step;
                document.getElementById('firmware-version').textContent =
                    data.firmware_version.substring(0, 1) + '.' +
                    data.firmware_version.substring(1, 3) + '.' +
                    data.firmware_version.substring(3);

                // Update status badge
                const statusBadge = document.getElementById('status');
                if (data.is_moving) {
                    statusBadge.textContent = 'MOVING';
                    statusBadge.className = 'status-badge status-moving';
                } else {
                    statusBadge.textContent = 'IDLE';
                    statusBadge.className = 'status-badge status-idle';
                }

                // Disable buttons during movement
                const buttons = document.querySelectorAll('.btn-step, .btn-goto');
                buttons.forEach(btn => {
                    btn.disabled = data.is_moving;
                });

            } catch (error) {
                console.error('Error fetching status:', error);
                showError('Failed to fetch status: ' + error.message);
            }
        }

        // Move by N steps
        async function moveSteps(steps, direction) {
            hideError();
            try {
                const response = await fetch('/simulator/move', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ steps, direction })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Move failed');
                }

                await updateStatus();
            } catch (error) {
                showError(error.message);
            }
        }

        // Move custom steps
        function moveCustomSteps(direction) {
            const input = document.getElementById('custom-steps');
            const steps = parseInt(input.value);

            if (isNaN(steps) || steps <= 0) {
                showError('Invalid input: must be a positive integer');
                return;
            }

            moveSteps(steps, direction);
        }

        // GoTo absolute position
        async function goToPosition() {
            hideError();
            const input = document.getElementById('goto-position');
            const position = parseInt(input.value);

            if (isNaN(position)) {
                showError('Invalid input: must be a positive integer');
                return;
            }

            if (position < 0 || position > state.maxStep) {
                showError(`Position must be between 0 and ${state.maxStep}`);
                return;
            }

            if (position === state.position) {
                showError('Already at target position', 'info');
                return;
            }

            try {
                const response = await fetch('/simulator/move', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ position })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Move failed');
                }

                await updateStatus();
            } catch (error) {
                showError(error.message);
            }
        }

        // Halt movement
        async function halt() {
            hideError();
            try {
                const response = await fetch('/simulator/halt', {
                    method: 'POST'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Halt failed');
                }

                await updateStatus();
            } catch (error) {
                showError(error.message);
            }
        }

        // Show error message
        function showError(message, type = 'error') {
            const errorBox = document.getElementById('error-box');
            errorBox.textContent = message;
            errorBox.classList.add('show');

            // Auto-hide after 5 seconds
            setTimeout(hideError, 5000);
        }

        // Hide error message
        function hideError() {
            const errorBox = document.getElementById('error-box');
            errorBox.classList.remove('show');
        }

        // Start polling
        function startPolling() {
            updateStatus(); // Initial update
            pollingInterval = setInterval(updateStatus, 250);
        }

        // Stop polling
        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }

        // Handle page visibility change
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopPolling();
            } else {
                startPolling();
            }
        });

        // Start polling on page load
        window.addEventListener('load', startPolling);

        // Cleanup on page unload
        window.addEventListener('beforeunload', stopPolling);
    </script>
</body>
</html>
